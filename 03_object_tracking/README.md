# Demo 3: Reachy Mini 物体追踪

结合 YOLO 目标检测和 Reachy Mini 控制，实现自动物体追踪功能。机器人会自动检测并追踪指定类别的物体，使目标始终保持在视野中央。

## 功能特性

- **YOLO v8 目标检测**: 支持检测 80+ 种常见物体（人、杯子、手机等）
- **自动追踪**: 检测到目标后自动调整机器人头部姿态
- **PID 控制**: 使用 PID 控制器实现平滑、稳定的追踪
- **实时显示**: 显示检测框、追踪状态和目标信息
- **可配置参数**: 支持调整模型、检测阈值、PID 参数等

## 快速开始

### 安装依赖

```bash
pip install reachy-mini opencv-python ultralytics
```

### 基本使用

```bash
# 追踪人（默认）
python object_tracking.py

# 追踪杯子
python object_tracking.py --class cup

# 追踪手机
python object_tracking.py --class "cell phone"

# 调整窗口大小（默认 60%，适应小屏幕）
python object_tracking.py --window-scale 0.5

# 使用更大的模型（更准确但更慢）
python object_tracking.py --model yolov8s.pt

# 调整检测阈值
python object_tracking.py --conf-threshold 0.7
```

## 支持的目标类别

YOLO v8 支持的常见类别包括：

| 类别名称 | 说明 |
|---------|------|
| person | 人 |
| cup | 杯子 |
| bottle | 瓶子 |
| cell phone | 手机 |
| laptop | 笔记本电脑 |
| tv | 电视 |
| keyboard | 键盘 |
| mouse | 鼠标 |
| book | 书 |
| chair | 椅子 |
| ... | 更多类别请参考 COCO 数据集 |

完整类别列表请运行程序后查看控制台输出。

## 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--backend` | 媒体后端 (default/gstreamer/webrtc) | default |
| `--resolution` | 摄像头分辨率 (640x480, 800x600, 1280x720) | 640x480 |
| `--window-scale` | 窗口缩放比例 (0.1-1.0) | 0.6 |
| `--model` | YOLO 模型 (yolov8n/s/m/l.pt) | yolov8n.pt |
| `--class` | 要追踪的目标类别 | person |
| `--conf-threshold` | 置信度阈值 (0-1) | 0.5 |
| `--iou-threshold` | IOU 阈值 (0-1) | 0.45 |
| `--pid-p` | PID 比例系数 | 0.8 |
| `--pid-i` | PID 积分系数 | 0.0 |
| `--pid-d` | PID 微分系数 | 0.2 |
| `--control-speed` | 控制响应速度（秒） | 0.3 |

## YOLO 模型选择

| 模型 | 大小 | 速度 | 精度 | 推荐场景 |
|------|------|------|------|----------|
| yolov8n.pt | 最小 | 最快 | 一般 | **实时追踪（推荐）** |
| yolov8s.pt | 小 | 快 | 较好 | 平衡性能 |
| yolov8m.pt | 中 | 中等 | 好 | 高精度需求 |
| yolov8l.pt | 大 | 慢 | 最好 | 离线处理 |

## 工作原理

1. **视频获取** (来自 demo1): 使用 `reachy_mini.media.get_frame()` 获取实时摄像头画面
2. **目标检测** (YOLO v8): 使用 YOLO 模型检测画面中的物体
3. **目标选择**: 从检测结果中选择最接近视野中心的物体作为追踪目标
4. **PID 控制**: 计算目标与视野中心的偏差，使用 PID 控制器生成平滑的控制信号
5. **机器人控制** (来自 demo2): 调用 `reachy_mini.look_at_image()` 控制机器人头部

## PID 调优建议

- **P (比例)**: 控制响应速度，过大会导致震荡，过小会导致响应慢
  - 追踪快速移动的物体: 增大 P (如 1.0-1.5)
  - 追踪静止/慢速物体: 减小 P (如 0.5-0.8)

- **I (积分)**: 消除稳态误差
  - 一般保持为 0 或很小的值 (如 0.01-0.1)

- **D (微分)**: 减少震荡，提高稳定性
  - 出现震荡时: 增大 D (如 0.3-0.5)
  - 响应过慢时: 减小 D (如 0.1-0.2)

## 界面说明

```
┌─────────────────────────────────────┐
│   Reachy Mini Object Tracking       │
│                                     │
│   Tracking: YES  ← 追踪状态         │
│   Target: person ← 目标类别          │
│                                     │
│   ┌─────────┐                       │
│   │  ━━━┃  │ ← 绿色框 = 追踪目标    │
│   │   ╋    │ ← 黄色十字 = 视野中心 │
│   └─────────┘                       │
│   ┌─────┐  ← 红色框 = 其他检测     │
└─────────────────────────────────────┘
```

## 操作说明

1. 运行程序后会显示摄像头画面
2. 程序会自动检测并追踪指定的目标类别
3. 机器人头部会自动调整，使目标保持在视野中央
4. 按 **`q`** 键退出程序

## 常见问题

**Q: 追踪不够稳定怎么办？**
A: 尝试调整 PID 参数，减小 P、增大 D；或者使用更大的 YOLO 模型。

**Q: 检测不到目标？**
A: 降低 `--conf-threshold` 值（如 0.3），或者检查目标类别是否正确。

**Q: 响应太慢？**
A: 增大 PID 的 P 值，减小 `--control-speed` 值，或使用更小的 YOLO 模型。

**Q: 如何查看所有支持的类别？**
A: 运行程序后查看控制台输出的 "可用类别" 列表。

## 技术架构

```
┌─────────────────┐
│  摄像头获取帧    │ ← demo1 方式
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  YOLO 目标检测   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  目标选择与过滤  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   PID 控制器    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 机器人运动控制   │ ← demo2 方式
└─────────────────┘
```

## 依赖

- Python 3.8+
- reachy-mini
- opencv-python
- ultralytics (YOLO v8)
- numpy

## 注意事项

1. 确保 Reachy Mini 的 daemon 服务已启动
2. 首次运行会自动下载 YOLO 模型，需要网络连接
3. 建议在光线充足的环境下使用
4. 目标物体应清晰可见，避免严重遮挡
