# Demo 16: åŒå‘éŸ³é¢‘æœåŠ¡

é€šè¿‡ WebSocket åœ¨ Reachy Mini å’Œ PC ä¹‹é—´å»ºç«‹åŒå‘éŸ³é¢‘è¿æ¥ï¼š
- **ä¸Šè¡Œ**: Reachy Mini éº¦å…‹é£ â†’ PCï¼ˆè¿œç¨‹ç›‘å¬ï¼‰
- **ä¸‹è¡Œ**: PC â†’ Reachy Mini æ’­æ”¾éŸ³é¢‘æ–‡ä»¶

---

## è¿è¡Œå¹³å°

| å¹³å° | æ”¯æŒæƒ…å†µ |
|------|----------|
| PC   | âœ… å®¢æˆ·ç«¯ |
| Reachy Mini | âœ… æœåŠ¡ç«¯ |

> æ­¤ demo åˆ†ä¸ºä¸¤éƒ¨åˆ†:
> - **æœåŠ¡ç«¯** - è¿è¡Œåœ¨ Reachy Mini ä¸Šï¼Œæä¾›éŸ³é¢‘æ¨æµå’Œæ’­æ”¾æœåŠ¡
> - **å®¢æˆ·ç«¯** - è¿è¡Œåœ¨å±€åŸŸç½‘å†…çš„ä»»æ„è®¾å¤‡ä¸Šï¼Œæ¥æ”¶éº¦å…‹é£æµ

---

## åŠŸèƒ½ç‰¹æ€§

### æœåŠ¡ç«¯ (Reachy Mini)
- **éº¦å…‹é£å®æ—¶æ¨æµ** - é€šè¿‡ WebSocket å®æ—¶æ¨é€éº¦å…‹é£éŸ³é¢‘
- **å¤šå®¢æˆ·ç«¯æ”¯æŒ** - æ”¯æŒå¤šä¸ª PC åŒæ—¶è¿æ¥ç›‘å¬
- **æ–‡ä»¶æ’­æ”¾** - è¿œç¨‹æ’­æ”¾ Reachy Mini ä¸Šçš„æœ¬åœ°éŸ³é¢‘æ–‡ä»¶
- **è‡ªåŠ¨ç®¡ç†** - æœ‰å®¢æˆ·ç«¯è¿æ¥æ—¶è‡ªåŠ¨å¯åŠ¨é‡‡é›†ï¼Œæ— å®¢æˆ·ç«¯æ—¶è‡ªåŠ¨åœæ­¢

### å®¢æˆ·ç«¯ (PC)
- **å®æ—¶æ¥æ”¶** - æ¥æ”¶å¹¶æ’­æ”¾ Reachy Mini éº¦å…‹é£éŸ³é¢‘
- **ä½å»¶è¿Ÿ** - ä½¿ç”¨ ffplay å®æ—¶è§£ç ï¼Œå»¶è¿Ÿæä½
- **è·¨å¹³å°** - æ”¯æŒ Windowsã€macOSã€Linux

---

## å‰ç½®æ¡ä»¶

### 1. ç³»ç»Ÿè¦æ±‚

- **æœåŠ¡ç«¯**: Reachy Mini (Linux)
- **å®¢æˆ·ç«¯**: ä»»æ„æ”¯æŒ Python çš„è®¾å¤‡
- **ç½‘ç»œ**: è®¾å¤‡åœ¨åŒä¸€å±€åŸŸç½‘

### 2. æœåŠ¡ç«¯ä¾èµ– (Reachy Mini)

```bash
# GStreamer Python ç»‘å®š
pip install fastapi uvicorn pydantic gobject

# æˆ–ä½¿ç”¨ç³»ç»ŸåŒ…ç®¡ç†å™¨
sudo apt install python3-gi python3-gi-cairo gstreamer1.0-python3-plugin-loader
```

### 3. å®¢æˆ·ç«¯ä¾èµ– (PC)

```bash
# Python ä¾èµ–
pip install websocket-client

# ffplay æ’­æ”¾å™¨

# Ubuntu/Debian
sudo apt install ffmpeg

# macOS
brew install ffmpeg

# Windows
# ä» https://ffmpeg.org/download.html ä¸‹è½½
```

---

## ä½¿ç”¨æ–¹æ³•

### ç¬¬ä¸€æ­¥: å¯åŠ¨æœåŠ¡ç«¯ (Reachy Mini)

```bash
cd demos/16_bidirectional_audio
python3 bidirectional_audio_server.py
```

æœåŠ¡å°†ç›‘å¬ `0.0.0.0:8002`ï¼Œå¯ä»å±€åŸŸç½‘å†…ä»»æ„è®¾å¤‡è®¿é—®ã€‚

**é¢„æœŸè¾“å‡º:**
```
============================================================
Reachy Mini åŒå‘éŸ³é¢‘æœåŠ¡
============================================================
éŸ³é¢‘è¾“å‡ºè®¾å¤‡: reachymini_audio_sink
éŸ³é¢‘è¾“å…¥è®¾å¤‡: reachymini_audio_src
éº¦å…‹é£é‡‡æ ·ç‡: 16000 Hz
============================================================

INFO:     Started server process [xxxxx]
INFO:     Waiting for application startup.
INFO:     ğŸš€ åŒå‘éŸ³é¢‘æœåŠ¡å·²å°±ç»ª
INFO:     ç›‘å¬åœ°å€: 0.0.0.0:8002
INFO:     éº¦å…‹é£ WebSocket: ws://<IP>:8002/audio/mic
INFO:     æ’­æ”¾ API: POST http://<IP>:8002/stream/play_file
```

---

### ç¬¬äºŒæ­¥: å¯åŠ¨å®¢æˆ·ç«¯ (PC)

#### æ–¹å¼ 1: æ¥æ”¶éº¦å…‹é£æµï¼ˆè¿œç¨‹ç›‘å¬ï¼‰â­

**è¿™æ˜¯ä¸»è¦åŠŸèƒ½** - å°† Reachy Mini å˜æˆè¿œç¨‹ç›‘å¬è®¾å¤‡ï¼

**å·¥ä½œåŸç†:**
1. PC è¿æ¥åˆ° Reachy Mini çš„ WebSocket æœåŠ¡
2. Reachy Mini å¼€å§‹é‡‡é›†éº¦å…‹é£éŸ³é¢‘
3. å®æ—¶æ¨æµåˆ° PC å¹¶æ’­æ”¾
4. ä½ å¯ä»¥å¬åˆ° Reachy Mini å‘¨å›´çš„å£°éŸ³

**ä½¿ç”¨æ­¥éª¤:**

```bash
# ä½¿ç”¨é»˜è®¤ IP
python3 receive_mic_stream.py

# æŒ‡å®šæœºå™¨äºº IP
python3 receive_mic_stream.py --robot-ip 10.42.0.75

# æŒ‡å®šç«¯å£
python3 receive_mic_stream.py --robot-ip 10.42.0.75 --port 8002

# æ˜¾ç¤º ffplay çª—å£ï¼ˆè°ƒè¯•ç”¨ï¼‰
python3 receive_mic_stream.py --robot-ip 10.42.0.75 --show-window
```

**é¢„æœŸè¾“å‡º:**
```
============================================================
Reachy Mini éº¦å…‹é£æµæ¥æ”¶
============================================================
ç›®æ ‡æœºå™¨äºº: 10.42.0.75
ç«¯å£: 8002
éŸ³é¢‘æ ¼å¼: OPUS
é‡‡æ ·ç‡: 16000 Hz
å£°é“: 1
============================================================

è¿æ¥åˆ° ws://10.42.0.75:8002/audio/mic
âœ… å·²è¿æ¥åˆ° Reachy Mini éº¦å…‹é£
æ­£åœ¨ç›‘å¬ ws://10.42.0.75:8002/audio/mic
æŒ‰ Ctrl+C åœæ­¢æ¥æ”¶

  å·²æ¥æ”¶: 125.3 KB (25.1 KB/s)
```

#### æ–¹å¼ 2: è¿œç¨‹æ’­æ”¾éŸ³é¢‘æ–‡ä»¶

```bash
# ä½¿ç”¨ curl æ’­æ”¾ Reachy Mini ä¸Šçš„éŸ³é¢‘æ–‡ä»¶
curl -X POST http://10.42.0.75:8002/stream/play_file \
  -H "Content-Type: application/json" \
  -d '{"file_path": "/home/pollen/audio.wav"}'
```

#### æ–¹å¼ 3: å¤šå®¢æˆ·ç«¯åŒæ—¶ç›‘å¬

å¯ä»¥åœ¨å¤šå° PC ä¸ŠåŒæ—¶è¿è¡Œå®¢æˆ·ç«¯ï¼Œéƒ½èƒ½æ¥æ”¶åˆ°éº¦å…‹é£æµï¼š

```bash
# PC 1
python3 receive_mic_stream.py --robot-ip 10.42.0.75

# PC 2
python3 receive_mic_stream.py --robot-ip 10.42.0.75

# PC 3
python3 receive_mic_stream.py --robot-ip 10.42.0.75
```

---

## API ç«¯ç‚¹

### WebSocket ç«¯ç‚¹

#### WS /audio/mic
éº¦å…‹é£éŸ³é¢‘æµç«¯ç‚¹

**è¿æ¥ç¤ºä¾‹:**
```python
import websocket

ws = websocket.WebSocketApp(
    "ws://10.42.0.75:8002/audio/mic",
    on_message=lambda ws, msg: print(f"æ”¶åˆ° {len(msg)} å­—èŠ‚")
)
ws.run_forever()
```

### HTTP ç«¯ç‚¹

#### GET /
æœåŠ¡ä¿¡æ¯

**å“åº”:**
```json
{
  "service": "Reachy Mini åŒå‘éŸ³é¢‘æœåŠ¡",
  "version": "1.0.0",
  "endpoints": {
    "websocket": "ws://<IP>:8002/audio/mic",
    "play_file": "POST http://<IP>:8002/stream/play_file"
  }
}
```

#### GET /health
å¥åº·æ£€æŸ¥

**å“åº”:**
```json
{
  "status": "healthy",
  "mic_clients": 2
}
```

#### GET /status
è·å–è¯¦ç»†çŠ¶æ€

**å“åº”:**
```json
{
  "service": "bidirectional_audio",
  "mic_forwarding": true,
  "mic_clients": 2,
  "audio_device": "reachymini_audio_src"
}
```

#### POST /stream/play_file
æ’­æ”¾æœ¬åœ°éŸ³é¢‘æ–‡ä»¶

**è¯·æ±‚ä½“:**
```json
{
  "file_path": "/path/to/audio.wav"
}
```

**å“åº”:**
```json
{
  "status": "playing",
  "file": "/path/to/audio.wav",
  "message": "å¼€å§‹æ’­æ”¾éŸ³é¢‘æ–‡ä»¶"
}
```

---

## å·¥ä½œåŸç†

### éŸ³é¢‘æµæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Reachy Mini ç«¯                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  éº¦å…‹é£ â†’ ALSA â†’ GStreamer â†’ Opus ç¼–ç  â†’ WebSocket â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ WebSocket (Opus)
                            â”‚ (ç«¯å£ 8002)
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          PC ç«¯                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  WebSocket â†’ æ¥æ”¶ Opus â†’ ffplay è§£ç  â†’ æ‰¬å£°å™¨è¾“å‡º    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### éŸ³é¢‘å‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| é‡‡æ ·ç‡ | 16000 Hz | è¯­éŸ³è´¨é‡ |
| å£°é“ | å•å£°é“ (1) | å…¼å®¹æ€§æœ€å¥½ |
| ç¼–ç  | Opus (32kbps) | é«˜å‹ç¼©æ¯”ï¼Œä½å»¶è¿Ÿ |
| åè®® | WebSocket | åŒå‘é€šä¿¡ |
| ç«¯å£ | 8002 | å¯é…ç½® |
| å»¶è¿Ÿ | ~50-100ms | å–å†³äºç½‘ç»œ |

### è‡ªåŠ¨ç®¡ç†æœºåˆ¶

1. **é¦–ä¸ªå®¢æˆ·ç«¯è¿æ¥** - è‡ªåŠ¨å¯åŠ¨ GStreamer éº¦å…‹é£é‡‡é›†
2. **å®¢æˆ·ç«¯æ–­å¼€** - è‡ªåŠ¨ç§»é™¤æ–­å¼€çš„è¿æ¥
3. **æ‰€æœ‰å®¢æˆ·ç«¯æ–­å¼€** - è‡ªåŠ¨åœæ­¢é‡‡é›†ï¼ŒèŠ‚çœèµ„æº
4. **æ–°å®¢æˆ·ç«¯è¿æ¥** - è‡ªåŠ¨æ¢å¤é‡‡é›†

---

## åº”ç”¨åœºæ™¯

| åœºæ™¯ | æè¿° | ä½¿ç”¨æ–¹å¼ |
|------|------|----------|
| **è¿œç¨‹ç›‘å¬** â­ | ç›‘å¬ Reachy Mini å‘¨å›´çš„å£°éŸ³ | `receive_mic_stream.py` |
| è¿œç¨‹è¯­éŸ³äº¤äº’ | å®æ—¶è¯­éŸ³é€šä¿¡ | ç»“åˆè¯­éŸ³è¯†åˆ«ä½¿ç”¨ |
| å¤šç‚¹ç›‘å¬ | å¤šä¸ªä½ç½®åŒæ—¶ç›‘å¬ | å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ |
| è¿œç¨‹æ’­æ”¾ | åœ¨ Reachy Mini ä¸Šæ’­æ”¾éŸ³é¢‘ | `POST /stream/play_file` |

---

## æ•…éšœæ’é™¤

### é—®é¢˜ 1: å®¢æˆ·ç«¯è¿æ¥å¤±è´¥

**é”™è¯¯**: `âŒ è¿æ¥å¤±è´¥: æ— æ³•è¿æ¥åˆ° ws://10.42.0.75:8002/audio/mic`

**è§£å†³**:
1. æ£€æŸ¥ Reachy Mini æ˜¯å¦å¼€æœº
2. ç¡®è®¤æœåŠ¡ç«¯å·²å¯åŠ¨ (`ps aux | grep bidirectional_audio_server`)
3. æ£€æŸ¥ IP åœ°å€æ˜¯å¦æ­£ç¡®
4. ç¡®è®¤é˜²ç«å¢™æœªé˜»æ­¢ç«¯å£ 8002

### é—®é¢˜ 2: æœªæ‰¾åˆ° ffplay

**é”™è¯¯**: `æœªæ‰¾åˆ° ffplay å‘½ä»¤`

**è§£å†³**:
```bash
# Ubuntu/Debian
sudo apt install ffmpeg

# macOS
brew install ffmpeg

# éªŒè¯å®‰è£…
ffplay -version
```

### é—®é¢˜ 3: æ— å£°éŸ³è¾“å‡º

**å¯èƒ½åŸå› **:
- ffplay å‚æ•°ä¸åŒ¹é…
- éŸ³é¢‘è®¾å¤‡é—®é¢˜
- éº¦å…‹é£æœªé‡‡é›†åˆ°å£°éŸ³

**è§£å†³**:
1. ä½¿ç”¨ `--show-window` æŸ¥çœ‹æ˜¯å¦æœ‰éŸ³é¢‘æ³¢å½¢
2. æ£€æŸ¥ç³»ç»ŸéŸ³é‡è®¾ç½®
3. ç¡®è®¤ Reachy Mini éº¦å…‹é£è®¾å¤‡æ­£ç¡® (`reachymini_audio_src`)

### é—®é¢˜ 4: éŸ³é¢‘å¡é¡¿

**è§£å†³**:
1. ä½¿ç”¨æœ‰çº¿ç½‘ç»œæ›¿ä»£ WiFi
2. æ£€æŸ¥ç½‘ç»œä¿¡å·å¼ºåº¦
3. ç¡®è®¤å¸¦å®½å……è¶³ï¼ˆOpus 32kbps éœ€æ±‚å¾ˆä½ï¼‰

---

## æ–‡ä»¶è¯´æ˜

| æ–‡ä»¶ | è¯´æ˜ | è¿è¡Œå¹³å° |
|------|------|----------|
| `bidirectional_audio_server.py` | åŒå‘éŸ³é¢‘æœåŠ¡ç«¯ | Reachy Mini |
| `receive_mic_stream.py` | éº¦å…‹é£æµæ¥æ”¶å®¢æˆ·ç«¯ | PC |

---

## ä¸å…¶ä»– Demo çš„å…³ç³»

| Demo | åŠŸèƒ½ | å…³ç³» |
|------|------|------|
| **Demo 08** | PC éŸ³é¢‘æ¨æµåˆ° Reachy Mini | åå‘æ•°æ®æµ |
| **Demo 09** | Reachy Mini éº¦å…‹é£æ¨æµåˆ° PC | æ­£å‘æ•°æ®æµ |

**ç»„åˆä½¿ç”¨**: Demo 08 + Demo 09 = å®Œæ•´çš„åŒå‘å®æ—¶éŸ³é¢‘é€šä¿¡

---

## é«˜çº§ç”¨æ³•

### é›†æˆåˆ°è¯­éŸ³è¯†åˆ«

```python
import websocket
import io

# æ¥æ”¶éŸ³é¢‘å¹¶ä¼ é€’ç»™è¯­éŸ³è¯†åˆ«
def on_message(ws, message):
    # å°† Opus æ•°æ®ä¼ é€’ç»™è¯­éŸ³è¯†åˆ«æœåŠ¡
    # ...

ws = websocket.WebSocketApp(
    "ws://10.42.0.75:8002/audio/mic",
    on_message=on_message
)
ws.run_forever()
```

### ä¿å­˜éŸ³é¢‘æµ

```bash
# ä½¿ç”¨ç®¡é“ä¿å­˜åˆ°æ–‡ä»¶
python3 receive_mic_stream.py --robot-ip 10.42.0.75 | \
  ffmpeg -f opus -ac 1 -ar 16000 -i - output.wav
```

---

## ç›¸å…³æ–‡æ¡£

- [Demo 08: éŸ³é¢‘æµ API](../08_audio_stream_api/)
- [Demo 05: WebRTC è§†é¢‘æµ](../05_webrtc_video_stream/)
- [API å‚è€ƒæ–‡æ¡£](../../docs/API_REFERENCE_CN.md)
- [ç½‘ç»œé…ç½®æŒ‡å—](../../docs/NETWORK_GUIDE_CN.md)

---

## è®¸å¯è¯

MIT License
